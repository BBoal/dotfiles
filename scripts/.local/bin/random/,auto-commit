#!/bin/sh

set -e

base="$(git rev-parse --show-toplevel 2>/dev/null)"

get_changes() {
    if [ -d "$base/.jj" ]; then
        jj diff
    elif [ -d "$base/.git" ]; then
        git diff --staged
    else
        echo "No git or jj repository found"
        exit 1
    fi
}

changes=$(get_changes)

if [ -z "$changes" ]; then
    echo "No changes to commit"
    exit 1
fi

printf "Generating message...\r"
commit_msg=$(echo "$changes" | esa +commit)
printf "\033[2K" # clear line

echo "$commit_msg"
read -n 1 -p "Use commit message (Y/n): " confirm

echo
if [ "$confirm" != "n" ]; then
    if [ -d ".jj" ]; then
        jj describe -m "$commit_msg"
    else
        git commit -m "$commit_msg"
    fi
else
    echo "Commit aborted"
    exit 1
fi
